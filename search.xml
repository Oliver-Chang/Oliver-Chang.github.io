<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>在 CentOS 7 下安装配置 GlusterFS</title>
      <link href="/2018/04/26/GlusterFS-Configure-in-Centos7/"/>
      <url>/2018/04/26/GlusterFS-Configure-in-Centos7/</url>
      
        <content type="html"><![CDATA[<h1 id="GlusterFS"><a href="#GlusterFS" class="headerlink" title="GlusterFS"></a>GlusterFS</h1><p>GlusterFS 是一个分布式文件系统，具有强大的横向扩展能力。主要提供的的存储功能为文件存储，当然也可通过其他方式支持快存储和对象存储。与存储相关的分布式文件系统还有 Ceph。</p><h2 id="Enviroment"><a href="#Enviroment" class="headerlink" title="Enviroment"></a>Enviroment</h2><p>OS: CentOS 7</p><h2 id="Install-GlusterFS"><a href="#Install-GlusterFS" class="headerlink" title="Install GlusterFS"></a>Install GlusterFS</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum -y install centos-release-gluster</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> yum install glusterfs-server</span></span><br></pre></td></tr></table></figure><h3 id="Configure-GlusterFS"><a href="#Configure-GlusterFS" class="headerlink" title="Configure GlusterFS"></a>Configure GlusterFS</h3><p>启动服务进程：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">enable</span> glusterd.service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl start glusterd.service</span></span><br></pre></td></tr></table></figure><p>GLusterFS 节点之间通信用到了 TCP 端口 24007-24008，所以启用所需端口：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> firewall-cmd --zone=public --add-port=24007-24008/tcp --permanent</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> firewall-cmd --reload</span></span><br></pre></td></tr></table></figure><p>或者选择关闭防火墙。</p><h2 id="GlusterFS-管理"><a href="#GlusterFS-管理" class="headerlink" title="GlusterFS 管理"></a>GlusterFS 管理</h2><p>这里简单介绍一下 GlusterFS 服务器端的管理程序 gluster 的使用。</p><p>这里假设拥有 4 台服务器：</p><table><thead><tr><th>HOSTNAME</th><th>IP-address</th></tr></thead><tbody><tr><td>node1</td><td>xxx.xxx.xxx.xx1</td></tr><tr><td>node2</td><td>xxx.xxx.xxx.xx2</td></tr><tr><td>node3</td><td>xxx.xxx.xxx.xx3</td></tr><tr><td>node4</td><td>xxx.xxx.xxx.xx4</td></tr></tbody></table><h3 id="Peer-操作"><a href="#Peer-操作" class="headerlink" title="Peer 操作"></a>Peer 操作</h3><p>GlusterFS 通过添加 Peer 来创建集群。</p><h4 id="Peer-probe"><a href="#Peer-probe" class="headerlink" title="Peer probe"></a>Peer probe</h4><p>添加 Peer 需要指定该节点的 IP 或者 HOSTNAME。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster peer probe &#123; &lt;HOSTNAME&gt; | &lt;IP-address&gt; &#125;</span></span><br></pre></td></tr></table></figure><p>例如在 node1 上：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster peer probe node2</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> gluster peer probe node3</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> gluster peer probe node4</span></span><br></pre></td></tr></table></figure><p>这样就能将 node1、node2、node3 和 node4 四台服务器连接，组成一个服务器集群。</p><h4 id="Peer-status"><a href="#Peer-status" class="headerlink" title="Peer status"></a>Peer status</h4><p>查询集群中的节点信息：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster peer status</span></span><br></pre></td></tr></table></figure><h4 id="Peer-detach"><a href="#Peer-detach" class="headerlink" title="Peer detach"></a>Peer detach</h4><p>移除 Peer 需要指定该节点的 IP 或者 HOSTNAME。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster peer detach &#123; &lt;HOSTNAME&gt; | &lt;IP-address&gt; &#125; [force]</span></span><br></pre></td></tr></table></figure><p>例如在 node1 移除 node2：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster peer probe node2</span></span><br></pre></td></tr></table></figure><p>不能在当前服务器从集群中移除当前服务器。</p><h3 id="Volume-操作"><a href="#Volume-操作" class="headerlink" title="Volume 操作"></a>Volume 操作</h3><p>GLusterFS 通过创建 Volume 来创建一个虚拟存储池，通过 Volume 的不同类型来提供不同的存储功能。</p><h4 id="Volume-create"><a href="#Volume-create" class="headerlink" title="Volume create"></a>Volume create</h4><p>创建卷需要指定卷的名字，类型和 Brick（Brcik 是指服务器上的一个目录，后端实际存储的目录）。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume create &lt;NEW-VOLNAME&gt; [stripe &lt;COUNT&gt;] [replica &lt;COUNT&gt; [arbiter &lt;COUNT&gt;]] [disperse [&lt;COUNT&gt;]] [disperse-data &lt;COUNT&gt;] [redundancy &lt;COUNT&gt;] [transport &lt;tcp|rdma|tcp,rdma&gt;] &lt;NEW-BRICK&gt;?&lt;vg_name&gt;... [force]</span></span><br></pre></td></tr></table></figure><p>不同类型的 Volume 对 Brick 的数量也有不同的要求。</p><p>假设有如下 Brick：</p><table><thead><tr><th>HOSTNAME</th><th>Brick</th></tr></thead><tbody><tr><td>node1</td><td>node1:/bricks/brick01</td></tr><tr><td>node2</td><td>node2:/bricks/brick01</td></tr><tr><td>node3</td><td>node3:/bricks/brick01</td></tr><tr><td>node4</td><td>node4:/bricks/brick01</td></tr></tbody></table><p>创建一个 replica 类型的 Volume，其 COUNT 至少为2 ,至少需要指定 2 个 Brick</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume create voltest1 replica 2 node1:/bricks/brick01 node2:/bricks/brick01 node3::/bricks/brick01 node4:/bricks/brick01</span></span><br></pre></td></tr></table></figure><p>该类型 volume 可以在存储文件的时候，在服务器保存一份该文件的副本。当然 GlusterFS 还有其他很多类型的 volume 这里就不一一介绍了。</p><h4 id="Volume-info"><a href="#Volume-info" class="headerlink" title="Volume info"></a>Volume info</h4><p>查看 Volume 的信息：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume info</span></span><br></pre></td></tr></table></figure><h4 id="Volume-status"><a href="#Volume-status" class="headerlink" title="Volume status"></a>Volume status</h4><p>查看 Volume 状态：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume status</span></span><br></pre></td></tr></table></figure><h4 id="Volume-delete"><a href="#Volume-delete" class="headerlink" title="Volume delete"></a>Volume delete</h4><p>删除 Volume：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume delete &lt;VOLNAME&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Brick-操作"><a href="#Brick-操作" class="headerlink" title="Brick 操作"></a>Brick 操作</h3><p>在创建完 Volume 后，如果需要更大的空间，可以通过添加新的 Brick 来提高整体容量，同时添加 Brick 时不会停止服务。</p><h4 id="Brick-add-bricks"><a href="#Brick-add-bricks" class="headerlink" title="Brick add-bricks"></a>Brick add-bricks</h4><p>命令：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume add-brick &lt;VOLNAME&gt; [&lt;stripe|replica&gt; &lt;COUNT&gt; [arbiter &lt;COUNT&gt;]] &lt;NEW-BRICK&gt; ... [force]</span></span><br></pre></td></tr></table></figure><p>一次添加 Brick 的数量要根据 Volume 的类型来决定。</p><p>例如 <code>voltest1</code> 是 <code>replica 2</code> 则添加时需要添加 2 的整数倍的 Brick。</p><p>要将 <code>node5/bricks/brick01</code>  <code>node6:/bricks/brick01</code>加入到 <code>voltest1</code>  Volume 中 </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume add-brick voltest1 node5/bricks/brick01 node6:/bricks/brick01</span></span><br></pre></td></tr></table></figure><h4 id="Rebalance"><a href="#Rebalance" class="headerlink" title="Rebalance"></a>Rebalance</h4><p>这时需要重新分配所保存文件的位置，这样可以确保每一个 Brick 都会被分配到文件，而不会过于集中在特定某一个 Brick。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume rebalance &lt;VOLNAME&gt; &#123;&#123;fix-layout start&#125; | &#123;start [force]|stop|status&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>查看 rebalance 状态</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume rebalance voltest1 status</span></span><br></pre></td></tr></table></figure><h4 id="Brick-替换"><a href="#Brick-替换" class="headerlink" title="Brick 替换"></a>Brick 替换</h4><p>命令：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume replace-brick &lt;VOLNAME&gt; &lt;SOURCE-BRICK&gt; &lt;NEW-BRICK&gt; &#123;commit force&#125;</span></span><br></pre></td></tr></table></figure><p>假设名称为 <code>voltest1</code> 的 Volume，使用 <code>node7:/bricks/brick01</code>替换 <code>node1:/bricks/birck01</code></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume replace-brick voltest1 node1:/bricks/brick01 node7:/bricks/brick01 start</span></span><br></pre></td></tr></table></figure><p>这时可以查看替换的状态</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume replace-brick voltest1 node1:/bricks/brick01 node5:/bricks/brick01 status</span></span><br></pre></td></tr></table></figure><p>最后 commit 确认移除旧的 Brick</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume replace-brick voltest1 node1:/bricks/brick01 node5:/bricks/brick01 commit</span></span><br></pre></td></tr></table></figure><h4 id="Brick-移除"><a href="#Brick-移除" class="headerlink" title="Brick 移除"></a>Brick 移除</h4><p>命令：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume remove-brick &lt;VOLNAME&gt; [replica &lt;COUNT&gt;] &lt;BRICK&gt; ... &lt;start|stop|status|commit|force&gt;</span></span><br></pre></td></tr></table></figure><p>移除 Brick 的数量也是由 Volume 的类型决定，</p><p>假设移除 <code>voltest1</code> 类型为 replica 2 的 Brick 那么移除的 Brick 数为 replica 的整数倍。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster volume remove-brick voltest1 node1:/bricks/brick01 node2:/bricks/brick01</span></span><br></pre></td></tr></table></figure><h3 id="Snapshot-操作"><a href="#Snapshot-操作" class="headerlink" title="Snapshot 操作"></a>Snapshot 操作</h3><p>Gluster 使用 LVM 的Snapshot 完成快照功能，也就是说您的 Brick 必须在 LVM 的环境中快照功能才能被使用。</p><p>使用 LVM 上的 Brick 创建的 Volume 可以通过快照来实现数据的快速恢复。</p><h4 id="Snapshot-create"><a href="#Snapshot-create" class="headerlink" title="Snapshot create"></a>Snapshot create</h4><p>命令：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster snapshot create &lt;snapname&gt; &lt;volname&gt; [no-timestamp] [description &lt;description&gt;] [force]</span></span><br></pre></td></tr></table></figure><h4 id="Snapshot-activate"><a href="#Snapshot-activate" class="headerlink" title="Snapshot activate"></a>Snapshot activate</h4><p>在创建后需要激活才能使用：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster snapshot activate &lt;snapname&gt; [force]</span></span><br></pre></td></tr></table></figure><h4 id="Snapshot-info"><a href="#Snapshot-info" class="headerlink" title="Snapshot info"></a>Snapshot info</h4><p>查看快照信息：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster snapshot info</span></span><br></pre></td></tr></table></figure><h4 id="Snapshot-restore"><a href="#Snapshot-restore" class="headerlink" title="Snapshot restore"></a>Snapshot restore</h4><p>GlusterFS 可以将 Volume 数据恢复到快照时的状态，但进行操作时必须停用 Volume，完成后重启。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster snapshot restore &lt;snapname&gt;</span></span><br></pre></td></tr></table></figure><p>虽然这样不影响工作，但会照成 Brick 位置的变更，若非必要，不要直接使用Snapshot 还原整个Volume。</p><h4 id="Snapshot-clone"><a href="#Snapshot-clone" class="headerlink" title="Snapshot clone"></a>Snapshot clone</h4><p>GlusterFS 提供从一个现有的快照，创建一个新的 Volume。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gluster snapshot <span class="built_in">clone</span> &lt;cloname&gt; &lt;snapname&gt;</span></span><br></pre></td></tr></table></figure><h2 id="GlusterFS-Client"><a href="#GlusterFS-Client" class="headerlink" title="GlusterFS Client"></a>GlusterFS Client</h2><p>GlusterFS 可以通过自己的客户端 Glusterfs 或者 Samba、NFS 来访问。</p><h3 id="开启防火墙"><a href="#开启防火墙" class="headerlink" title="开启防火墙"></a>开启防火墙</h3><p>为 Glusterfs、Samba 和 NFS 开启防火墙。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> firewall-cmd --zone=public --add-service=nfs --add-service=samba --add-service=samba-client --permanent</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> firewall-cmd --zone=public --add-port=111/tcp --add-port=139/tcp --add-port=445/tcp --add-port=965/tcp --add-port=2049/tcp \</span></span><br><span class="line">--add-port=38465-38469/tcp --add-port=631/tcp --add-port=111/udp --add-port=963/udp --add-port=49152-49251/tcp  --permanent</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> firewall-cmd --reload</span></span><br></pre></td></tr></table></figure><p>当然也可选择关闭防火墙。</p><h3 id="Glusterfs-client"><a href="#Glusterfs-client" class="headerlink" title="Glusterfs client"></a>Glusterfs client</h3><p>安装 GLusterfs client：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum install glusterfs glusterfs-fuse attr -y</span></span><br></pre></td></tr></table></figure><p>挂载:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mount -t glusterfs node1:/glustervol1 /mnt/</span></span><br></pre></td></tr></table></figure><p>node1 为一个服务器节点。</p><h3 id="Samba"><a href="#Samba" class="headerlink" title="Samba"></a>Samba</h3><p>安装：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum install samba samba-client samba-common samba-vfs-glusterfs selinux-policy-targeted -y</span></span><br></pre></td></tr></table></figure><p>启动服务：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl start smb.service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">enable</span> smb.service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl start nmb.service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">enable</span> nmb.service</span></span><br></pre></td></tr></table></figure><p>在每个服务器端，修改 <em>/etc/samba/smb.conf</em> 文件内的 GlusterFS 已创建 Volume 的配置：</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[gluster-glustervol1]</span></span><br><span class="line"><span class="attr">comment</span> = For samba share of volume glustervol1</span><br><span class="line">vfs objects = glusterfs</span><br><span class="line">glusterfs:volume = glustervol1</span><br><span class="line">glusterfs:logfile = /var/log/samba/glusterfs-glustervol1.%M.log</span><br><span class="line">glusterfs:loglevel = 7</span><br><span class="line"><span class="attr">path</span> = /</span><br><span class="line">read only = no</span><br><span class="line">guest ok = yes</span><br></pre></td></tr></table></figure><p>在后面添加一行 <strong>kernel share modes = No</strong>。这个是为了解决挂载 samba 后创建文件后出现同时创建了多个文件的问题。具体原因不知道，如果有知道的可以交流一下。</p><p>修改后为：</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[gluster-glustervol1]</span></span><br><span class="line"><span class="attr">comment</span> = For samba share of volume glustervol1</span><br><span class="line">vfs objects = glusterfs</span><br><span class="line">glusterfs:volume = glustervol1</span><br><span class="line">glusterfs:logfile = /var/log/samba/glusterfs-glustervol1.%M.log</span><br><span class="line">glusterfs:loglevel = 7</span><br><span class="line"><span class="attr">path</span> = /</span><br><span class="line">read only = no</span><br><span class="line">guest ok = yes</span><br><span class="line">kernel share modes = No</span><br></pre></td></tr></table></figure><p>为了能够访问 Samba 需要创建用户，并设置密码。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> smbpasswd -a sambauser</span></span><br></pre></td></tr></table></figure><p>sambauser 是一个用户名，按需要进行创建。</p><p>设置 SELinux 运行 Samba 共享：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> setsebool -P samba_share_fusefs on</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> setsebool -P samba_load_libgfapi on</span></span><br></pre></td></tr></table></figure><p>当然也可以选择关闭 SELinux</p><p>编辑<code>/etc/sysconfig/selinux</code></p><p>将</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">SELINUX</span>=enforcing</span><br></pre></td></tr></table></figure><p>改为</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">SELINUX</span>=disabled</span><br></pre></td></tr></table></figure><p>挂载：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mount -t cifs \\\\gluster1.example.com\\gluster-glustervol1 /mnt/ -o user=sambauser,pass=mypassword</span></span><br></pre></td></tr></table></figure><p>在 Windows 下 可以通过在资源管理器里添加一个新的位置来链接 Samba 共享。</p><h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><p>需要开启 RPC 服务：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">enable</span> rpcbind</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl start rpcbind</span></span><br></pre></td></tr></table></figure><p>挂载：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mount -t nfs gluster1.example.com:/glustervol1 /mnt/</span></span><br></pre></td></tr></table></figure><h2 id="Block-Storage"><a href="#Block-Storage" class="headerlink" title="Block Storage"></a>Block Storage</h2><p>块存储是非常常用的存储方式，GlusterFS 主要是文件存储，对于块存储要通过镜像文件的方式创建 iscsi target。</p><p>这里推荐一个工具来创建帮助快速创建 <a href="https://github.com/gluster/gluster-block.git" target="_blank" rel="noopener"><strong>gluster-block</strong></a> 。</p><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><blockquote><p>CentOS Wiki: <a href="https://wiki.centos.org/zh/SpecialInterestGroup/Storage/gluster-Quickstart?highlight=%28GlusterFS%29" target="_blank" rel="noopener">gluster-Quickstart</a>  <a href="https://wiki.centos.org/zh/HowTos/GlusterFSonCentOS?highlight=%28GlusterFS%29" target="_blank" rel="noopener">GlusterFSonCentOS</a></p><p>Gluster-Storage_GitBook: <a href="http://www.l-penguin.idv.tw/book/Gluster-Storage_GitBook/" target="_blank" rel="noopener">http://www.l-penguin.idv.tw/book/Gluster-Storage_GitBook/</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> GlusterFS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Centos </tag>
            
            <tag> GlusterFS </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
